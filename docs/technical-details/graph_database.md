# Graph Database

## Id Structure

The Id structure in our graph database follows the naming convention outlined in the `/naming-conventions/Id.md` file. Here's a brief overview:

Structure: `[Site]-[Area]-[Function]-[Type]-[Instance]`

Example: `DALLAS-PROD-OPS-TEAM-001`

Components:
- [Site]: Derived from ISA-95's Enterprise-Site hierarchy
- [Area]: Aligns with ISA-95's Area concept
- [Function]: Influenced by PERA's functional levels and Industry 4.0 concepts
- [Type]: Added to accommodate various entities, including AI agents
- [Instance]: Common in many industrial naming conventions for unique identification

## Graph Database Nodes

Our graph database consists of several types of nodes, each representing different entities in the XMPro MAGS system. 

Here's an overview of the main node types and their properties:

### Artifact

| Property    | Type     | Description                                    |
|-------------|----------|------------------------------------------------|
| created_date  | DateTime | Timestamp of when the instance was created     |
| id          | String   | Unique identifier for the artifact       |
| type        | String   | The type of artifact ( `Audit` or `Conversation` or `Plan` or `Tool` )|

#### `Plan` Specific properties

| Property             | Type     | Description                                              |
|----------------------|----------|----------------------------------------------------------|
| active               | Boolean  | Indicates if the plan is currently active                |
| agent_id             | String  | The agent instances this plan belongs to                |
| goal                 | String  | The goal of the plan                                     |
| last_modified_date   | DateTime | Date and time when the plan was last modified            |
| pddl_domain          | String  | PDDL domain description for the plan                     |
| pddl_plan            | String  | PDDL plan generated                                      |
| pddl_problem         | String  | PDDL problem description for the plan                    |
| prompt               | String  | The prompt used                       |
| response             | String  | Response associated with the plan                        |
| status               | String  | Current status of the plan                               |
| timestamp            | Integer  | Timestamp of the plan                                    |
| total_api_calls      | Integer  | Total number of API calls made for the plan              |
| total_response_time  | Integer  | Total time taken for responses related to the plan       |
| total_token_usage    | Integer  | Total number of tokens used for the plan                 |

#### `Tool` Specific Properties

| Property       | Type     | Description                                        |
|----------------|----------|----------------------------------------------------|
| input          | String  | Input provided to the tool                         |
| name           | String   | The name of the tool                               |
| result         | String  | Result generated by the tool                     |
| success        | Boolean  | Indicates if the tool was successful   |

---

### AgentInstance

| Property           | Type     | Description                                    |
|--------------------|----------|------------------------------------------------|
| active             | Boolean  | Indicates if the instance is currently active  |
| agent_id           | String   | Unique identifier for the agent instance       |
| available_actions  | String (JSON) | List of available actions for this agent instance |
| created_date       | DateTime | Timestamp of when the instance was created     |
| last_modified_date | DateTime | Timestamp of when the instance was last modified |
| name               | String   | Name of the agent instance                     |
| profile_id         | String   | Id of the associated agent profile             |
| task_prompt        | String   | The prompt used for the tasks of a plan        |
| type               | String   | The type of agent instance (`standard`, `content`, 'assistant') |
| user_prompt        | String   | The initial prompt given to the agent instance |

---

### AgentProfile

| Property                | Type             | Description                                           |
|-------------------------|------------------|-------------------------------------------------------|
| active                  | Boolean          | Indicates if the profile is currently active          |
| allowed_planning_method | Array of Strings | List of planning methods available to this agent profile|
| category                | String           | Category of the profile                               |
| created_date            | DateTime         | Timestamp of when the profile was created             |
| decision_parameters     | String (JSON)    | Parameters for decision making                        |
| deontic_rules           | Array of Strings | Rules governing the agent's behavior                  |
| experience              | String           | Description of the agent's simulated experience       |
| interaction_preferences | String (JSON)    | Preferences for interaction                           |
| last_modified_date      | DateTime         | Timestamp of when the profile was last modified       |
| max_tokens              | Integer          | Maximum number of tokens for responses                |
| memory_parameters       | String (JSON)    | Parameters for memory management                      |
| model_name              | String           | Name of the specific AI model                         |
| model_provider          | String           | Provider of the AI model used                         |
| name                    | String           | Name of the agent profile                             |
| observation_prompt      | String           | Prompt template for observations                      |
| organizational_rules    | Array of Strings | Rules specific to the organization                    |
| performance_metrics     | String (JSON)    | Metrics for measuring performance                     |
| profile_id              | String           | Unique identifier for the agent profile               |
| rag_collection_name     | String           | Name of the RAG collection used                       |
| rag_top_k               | Integer          | Number of top results to retrieve from RAG            |
| rag_vector_size         | Integer          | Size of the vector for RAG                            |
| reflection_prompt       | String           | Prompt template for reflections                       |
| skills                  | Array of Strings | List of skills the agent possesses                    |
| system_prompt           | String           | The system prompt for the agent                       |
| tags                    | Array of Strings | Tags associated with the profile                      |
| use_general_rag         | Boolean          | Whether to use general RAG or not                     |

---

### Decision

| Property         | Type     | Description                                               |
|------------------|----------|-----------------------------------------------------------|
| created_date     | DateTime | Date and time when the decision was created            |
| decision_id      | String   | Unique identifier for the decision                     |
| goal             | String   | The goal of the decision                               |
| max_tokens       | Integer  | Maximum number of tokens for responses                 |
| model_name       | String   | Name of the specific AI model                          |
| model_provider   | String   | Provider of the AI model used                          |
| reasoning        | String   | Reasoning behind the decision                          |
| response_time    | String   | Time taken to generate the decision                    |
| selected_method  | String   | Method selected for the decision                       |
| timestamp        | Integer  | Timestamp of the decision                              |
| token_usage      | Integer  | Number of tokens used in generating the decision       |
| trigger_context  | String   | Context that triggered the decision                    |
| trigger_reason   | String   | Reason for triggering the decision                     |
| trigger_response | String   | Response to the trigger                                |
| type             | String   | Type of the decision ( `Observation` or `Planning` )   |

#### `Planning` Specific Properties

| Property         | Type     | Description                                               |
|------------------|----------|-----------------------------------------------------------|
| goals_prompt     | Unknown  | Prompt used to generate goals                             |
| goals_response   | Unknown  | Response containing generated goals                       |
| resulting_id     | Unknown  | Identifier resulting from the planning decision           |

---

### Entry

| Property        | Type     | Description                                              |
|-----------------|----------|----------------------------------------------------------|
| created_date    | DateTime | Date and time when the entry was created                 |
| id              | String   | Unique identifier for the entry                          |
| timestamp       | Integer  | Timestamp of the entry                                   |
| type            | String   | Type of the entry ( `Action` or `Audit` or `Conversation` or `Planning` or `Task` or `Tool` or `ToolLLM` )   |

#### `Action` Specific Properties

| Property       | Type     | Description                                        |
|----------------|----------|----------------------------------------------------|
| name           | String        | Name of the action                               |
| last_modified_date | DateTime  | Timestamp of when the action was last modified   |

#### `Audit` Specific Properties

| Property        | Type     | Description                                              |
|-----------------|----------|----------------------------------------------------------|
| change          | String   | The change that was made                                 |
| user            | String   | The user making the entry                                |

#### `Conversation` Specific Properties

| Property        | Type     | Description                                              |
|-----------------|----------|----------------------------------------------------------|
| prompt          | String   | The prompt used                                          |
| rag_query_time  | Integer  | Time taken for RAG (Retrieval-Augmented Generation) query|
| reply           | String   | The reply to the user                                    |
| response        | String   | The response generated                                   |
| response_time   | Integer  | Time taken to generate the response                      |
| summary         | String   | Summary                                                  |
| timestamp       | Integer  | Timestamp of the entry                                   |
| token_usage     | Integer  | Number of tokens used                                    |
| user_query      | String   | The query provided by the user                           |

#### `Planning` Specific Properties

| Property        | Type     | Description                                              |
|-----------------|----------|----------------------------------------------------------|
| name            | String   | Name of the planning entry                               |
| prompt          | String   | The prompt used                                          |
| rag_query_time  | Integer  | Time taken for RAG (Retrieval-Augmented Generation) query|
| response        | String   | The response generated                                   |
| response_time   | Integer  | Time taken to generate the response                      |
| timestamp       | Integer  | Timestamp of the entry                                   |
| token_usage     | Integer  | Number of tokens used                                    |

#### `Task` Specific Properties

| Property       | Type     | Description                                        |
|----------------|----------|----------------------------------------------------|
| agent_id        | String           | Agent Instance this task is linked to                   |
| description        | String           | Description of the task                   |
| number        | Integer           | No of the task                   |
| last_modified_date | DateTime  | Timestamp of when the task was last modified   |
| pddl_step     | String           | The PDDL description of the task                   |
| status        | String           | Status of the task                   |

#### `Tool` Specific Properties

| Property       | Type     | Description                                        |
|----------------|----------|----------------------------------------------------|
| additional_data | String  | The amount of data processed   |
| attempt_number | Integer   | The attempt number for the tool                  |
| data_processed | Integer  | The amount of data processed   |
| response_time  | Integer  | Time taken for response       |
| result         | String  | Result generated by the tool                     |
| success        | Boolean  | Indicates if the tool was successful   |

#### `ToolLLM` Specific Properties

| Property       | Type     | Description                                        |
|----------------|----------|----------------------------------------------------|
| max_tokens     | Integer          | Maximum number of tokens for responses                |
| model_name     | String           | Name of the specific AI model                         |
| model_provider | String           | Provider of the AI model used                         |
| prompt         | Integer  | The prompt used  |
| response       | String  | The response generated                |
| response_time  | Integer  | Time taken to generate the response                      |
| token_usage    | Integer  | Number of tokens used                 |

---

### Library

| Property     | Type     | Description                            |
|--------------|----------|---------------------------------|
| created_date | DateTime | Date and time when the library was created   |
| name         | String   | Name of the library           |
| type         | String   | Type of the library ( `Prompt` or `Tool` )   |

---

### Memory

| Property       | Type     | Description                                                    |
|----------------|----------|----------------------------------------------------------------|
| created_date   | DateTime | Timestamp of when the memory was created |
| id             | String   | Unique identifier for the memory |
| importance     | Float    | Importance score of the memory  |
| last_accessed  | DateTime | Timestamp of when the memory was last accessed |
| prompt         | String   | The prompt or content associated with this memory              |
| rag_query_time | Float    | Time taken for RAG query                             |
| response       | String   | The response content                                           |
| response_time  | Float    | Time taken for the response           |
| timestamp      | Integer  | Unix timestamp                               |
| token_usage    | Integer  | Number of tokens used                               |
| type           | String   | Type of memory ( `Observation` or `Reflection` )                              |

---

### Metrics

| Property               | Type     | Description                                           |
|------------------------|----------|-------------------------------------------------------|
| average_response_time  | Float    | Average time taken for responses                      |
| created_date           | DateTime | Timestamp of when the aggregate was created           |
| failed_calls           | Integer  | Number of failed calls                                |
| last_modified_date     | DateTime | Timestamp of when the aggregate was last modified     |
| successful_calls       | Integer  | Number of successful calls                            |
| total_calls            | Integer  | Total number of calls made                            |
| total_data_processed   | Integer  | Total amount of data processed                        |
| total_response_time    | Float    | Total time taken for all responses                    |
| type                   | String   | Type of the metrics ( `Aggregate` )                   |

---

### Prompt

| Property           | Type             | Description                                           |
|--------------------|------------------|-------------------------------------------------------|
| access_level       | String           | Access level required to use or modify the prompt     |
| active             | Boolean          | Whether the prompt is currently active                |
| author             | String           | Author of the prompt                                  |
| category           | String           | Category of the prompt                                |
| created_date       | DateTime         | Date and time when the prompt was created             |
| description        | String           | Description of the prompt's purpose                   |
| internal_name      | String           | Internal name used for backend operations             |
| last_modified_date | DateTime         | Date and time of the last modification                |
| max_tokens         | Integer          | Maximum number of tokens for responses                |
| model_name         | String           | Specific AI model the prompt is optimized for         |
| model_provider     | String           | Provider of the AI model the prompt is designed for   |
| name               | String           | Name of the prompt                                    |
| prompt             | String           | The actual prompt text                                |
| prompt_id          | String           | Unique identifier for the prompt                      |
| reserved_fields    | Array of Strings | Fields reserved for specific use in the prompt        |
| tags               | Array of Strings | Tags associated with the prompt                       |
| type               | String           | The type of prompt                                    |
| version            | Integer          | Version number of the prompt                          |

---

### System Options

| Property                      | Type             | Description                                           |
|-------------------------------|------------------|-------------------------------------------------------|
| created_date                  | DateTime         | Date and time when the options were created           |
| id                            | String           | Unique identifier for the system options              |
| last_modified_date            | DateTime         | Date and time of the last modification                |
| models_providers              | Array of Strings | List of model providers                               |
| prompt_access_levels          | JSON String      | List of access levels with values and descriptions    |
| prompt_types                  | JSON String      | List of prompt types with values and descriptions     |
| rag_schema                    | JSON String      | List of the RAG collection schemas used               |
| reserved_fields_observation   | Array of Strings | Fields reserved for observations                      |
| reserved_fields_reflection    | Array of Strings | Fields reserved for reflections                       |

---

### Team

| Property                  | Type             | Description |
|---------------------------|------------------|----------------------------------------------------------------|
| active                    | Boolean          | Indicates if the team is currently active                |
| author                    | String           | Author of the team |
| category                  | String           | Category of the prompt                                |
| communication_protocol    | JSON String      | Details of communication channels, frequencies, and reporting schedules |
| compliance_requirements   | Array of Strings | List of regulatory compliance standards |
| created_date              | DateTime         | Date and time when the team was created |
| decision_making           | JSON String      | List of decision-making protocols with methods and applicable scenarios |
| description               | String           | Brief description of the team's purpose |
| escalation_policy         | JSON String      | Detailed policy for handling escalations, including conditions and actions |
| id                        | Integer          | Unique identifier for the team |
| last_modified_date        | DateTime         | Date and time of the last modification |
| name                      | String           | Name of the team |
| objectives                | Array of Strings | List of team objectives |
| operational_constraints   | JSON String      | Operational limits and parameters for the team's activities |
| performance_metrics       | JSON String      | Key performance indicators with targets and weights |
| tags                      | Array of Strings | Tags associated with the prompt                       |
| team_id                   | String           | Unique identifier for the team within the organization |
| version                   | String           | Version number of the team configuration |

---

### Tool

| Property           | Type     | Description |
|--------------------|----------|-------------------------------------------------------------------------------------------|
| active             | Boolean  | Indicates if the tool is currently active                |
| class_name         | String   | The class name of the tool |
| created_date       | DateTime | Date and time when the tool was created |
| description        | String   | A brief description of the tool's functionality |
| id                 | Integer  | Unique identifier for the tool |
| last_modified_date | DateTime | Date and time of the last modification |
| max_tokens         | Integer  | The maximum number of tokens the tool can process (if applicable) |
| model_name         | String   | The name of the model used by the tool (if applicable) |
| model_provider     | String   | The provider of the model (if applicable) |
| name               | String   | The name of the tool |
| options            | String   | Additional options for the tool (empty in this case) |
| prompt_system      | String   | The system prompt used by the tool (if applicable) |
| prompt_user        | String   | The prompt used by the tool (if applicable) |
| reserved_fields    | Array of Strings | Fields reserved for the user prompt |

This graph structure allows for efficient querying and analysis of the relationships between different entities in the XMPro AI Agents system.

## Sample Cyphers

### Agent: Get the current active plan

> [!NOTE]  
> Adjust the `$agent_id` with the Agent Instance to get their specific active plan

```cypher
MATCH (p:Artifact {type: 'Plan', active: true, agent_id: $agentId})
OPTIONAL MATCH (p)-[:HAS_TASK]->(t:Entry {type: 'Task'})
WHERE t.status <> 'Cancelled' OR t.status IS NULL
OPTIONAL MATCH (t)-[:HAS_ACTION]->(a:Entry {type: 'Action'})
RETURN p, 
 t,
 collect(a) as actions
```

### Agent: Return a Specific Instance (all nodes + relationships)

> [!CAUTION]
> Use with caution can return a lot of data if not filtered

> [!NOTE]  
> Adjust the `$agent_id` with the Agent Instance your looking for

```cypher
MATCH (n:AgentInstance {agent_id: $agent_id})
OPTIONAL MATCH (n)-[r*1..]->(m)
RETURN n, r, m
```

### Conversation: Get History

> [!NOTE]  
> Adjust the `$conversationId` to get a specific conversation thread

```cypher
MATCH (c:Artifact {id: $conversationId})-[:HAS_ENTRY]->(e:Entry)
OPTIONAL MATCH (e)-[:TRIGGERED]->(o:Observation)
RETURN e.prompt as prompt, e.response as response, e.summary as summary, e.user_query as user_query, 
        e.timestamp as timestamp, e.token_usage as token_usage, e.response_time as response_time, e.tools_used as toolsUsed,
        o.id as observationId
ORDER BY e.timestamp ASC
```

